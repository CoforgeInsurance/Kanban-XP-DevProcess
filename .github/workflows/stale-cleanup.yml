name: Stale Issues & Branch Cleanup

# Keep board clean and branches organized
on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  stale-issues:
    name: Mark Stale Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Stale issue management
        uses: actions/stale@v9
        with:
          # Issues
          days-before-issue-stale: 30
          days-before-issue-close: 7
          stale-issue-label: 'stale'
          stale-issue-message: |
            ⏰ **This issue has been inactive for 30 days**
            
            It will be automatically closed in 7 days unless there is activity.
            
            **To keep it open**:
            - Add a comment with updates or questions
            - Remove the `stale` label
            - Move it to a different status in the project board
            
            If this issue is still relevant but blocked, please:
            1. Add context about what's blocking it
            2. Add label `blocked` to prevent auto-close
          close-issue-message: |
            🔒 **Closing due to inactivity**
            
            This issue was automatically closed after 37 days of inactivity.
            
            If still needed, please:
            - Reopen and update with current context
            - Create a new issue with fresh requirements
          
          # PRs - more aggressive
          days-before-pr-stale: 14
          days-before-pr-close: 7
          stale-pr-label: 'stale'
          stale-pr-message: |
            ⏰ **This PR has been inactive for 14 days**
            
            PRs should move quickly through the pipeline. This will close in 7 days.
            
            **For agent-generated PRs**: Consider closing and reassigning issue to agent with improved specs.
            
            **For human PRs**: Please update or request review to keep active.
          close-pr-message: |
            🔒 **Closing stale PR**
            
            Closed due to 21 days of inactivity. Please reopen if still needed.
          
          # Exemptions
          exempt-issue-labels: 'blocked,on-hold,epic'
          exempt-pr-labels: 'on-hold,wip'
          exempt-all-milestones: true
          
          # Operations
          operations-per-run: 100
          remove-stale-when-updated: true

  cleanup-merged-branches:
    name: Delete Merged Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get all branches
      
      - name: Delete merged branches
        run: |
          echo "🧹 Cleaning up merged branches..."
          
          # Get all merged branches except main and develop
          git branch -r --merged origin/main | \
            grep -v "origin/main" | \
            grep -v "origin/develop" | \
            grep -v "HEAD" | \
            sed 's/origin\///' | \
            while read branch; do
              # Skip if branch doesn't exist on remote
              if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
                echo "Deleting merged branch: $branch"
                git push origin --delete "$branch" || echo "Failed to delete $branch"
              fi
            done
          
          echo "✅ Branch cleanup complete"

  cleanup-stale-copilot-branches:
    name: Clean Stale Agent Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Delete old copilot branches without PRs
        uses: actions/github-script@v8
        with:
          script: |
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // Find copilot branches older than 7 days without open PRs
            for (const branch of branches) {
              if (!branch.name.startsWith('copilot/')) continue;
              
              // Check if branch has open PR
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch.name}`,
                state: 'open'
              });
              
              if (prs.length === 0) {
                // Get branch age from last commit
                const { data: commit } = await github.rest.repos.getCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: branch.commit.sha
                });
                
                const commitDate = new Date(commit.commit.committer.date);
                const daysSinceCommit = (Date.now() - commitDate) / (1000 * 60 * 60 * 24);
                
                if (daysSinceCommit > 7) {
                  console.log(`Deleting stale copilot branch: ${branch.name} (${Math.round(daysSinceCommit)} days old)`);
                  
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${branch.name}`
                  });
                }
              }
            }
